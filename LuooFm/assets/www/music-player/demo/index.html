<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, target-densitydpi=device-dpi" />
  <title>Player</title>
  <link href='css/Chivo.css' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="css/demo.css">
  <script type="text/javascript" src="js/phonegap.js"></script>
  <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="js/iscroll.js"></script>
  <script type="text/javascript" src="js/myplaylist.js"></script>
  <script type="text/javascript">
        $(document).ready(function(){
             var updater;
             var currentTrack;
             var control = "play";           
            /*
            * 将拿到的播放列表渲染到列表页面，基本信息写在li元素里面，单击的时候，直接获取这些信息送入后台
            */
             var renderVol = function(vol){
                 var playListHtml = ' <ul vol="' + vol["vol"] + '"><h3><span>' + vol["title"] + '</span></h3>';
                 var playList = vol["playList"];
                 var tracks = '';
                 for (var i = 0; i < playList.length; i++){
                    tracks = '<li index=\"' + i + '\" mp3="' + playList[i]["mp3"] + '" poster="' + playList[i]["cover"]+ '" artist="' + playList[i]["artist"]+ '"><span>' + playList[i]["title"] + '</span></li>';
                    playListHtml += tracks;
                 }
                 playListHtml += '</ul>';                 
                 $('.list-wrap').append(playListHtml);
             }    
             /*
             将毫秒数转换成分秒格式，显示在播放器页面             
              */
            var timeFormate = function(ms) {
              var seconds = Math.floor(ms/1000);
              var minute = Math.floor(seconds/60);
              var second = seconds%60;
              return minute + ":" + (second<10?"0" + second:second);
            }   
            /*
            上一曲下一曲的响应方式通过调用li的上一个元素或者下一个元素的click事件来触发。click事件的响应中有具体的播放控制
            最上一个元素的上一曲将跳转到本期的最末歌曲
             */
            var playPreTrack = function(index, vol) {
              var par = $('.list-wrap ul[vol=' + vol + ']');
              if (parseInt(index) == 0){
                  par.find('li:last').click();
              }else{
                  par.find('li[index=' + (parseInt(index) - 1) + ']').click();
              }
            }    
            /*
            上一曲下一曲的响应方式通过调用li的上一个元素或者下一个元素的click事件来触发。click事件的响应中有具体的播放控制
            最末歌曲的下一首将播放本期的第一首歌曲
             */
            var playNextTrack = function(index, vol)  {
              var par = $('.list-wrap ul[vol=' + vol + ']');
              if (parseInt(index) == par.find('li').length - 1){
                  par.find('li:first').click();
              }else{
                  par.find('li[index=' + (parseInt(index) + 1) + ']').click();
              }
            }   
            /*
            播放歌曲唯一入口，所有行为都通过这个函数播放.
             */
            var playTrack = function(index, vol){
              var target = $('.list-wrap ul[vol=' + vol + '] li[index=' + index + ']');
              var url =  target.attr('mp3');
              var vol = target.parent().attr('vol');
                if (window.LuooFm){
                    LuooFm.play(url, vol);
                    control = "play";
                }
                $('.time .now').text(timeFormate(0));
                $('.time .total').text(timeFormate(0));
                $('.timing .played').css('width', 0);
                $('.timing .download').css('width', 0);
                /*
                没个一秒做定时更新，包括播放时间更新。下载状态更新，播放状态更新等。
                 */
                clearInterval(updater);                
                updater = setInterval(function(){
                  if (!window.LuooFm) return;
                  var status = LuooFm.getPlayingStatus();
                  var statusObj = JSON.parse(status);
                  console.log(status);
                  if (statusObj["playing"] != undefined){
                      $('.time .now').text(timeFormate(statusObj['cur']));
                      $('.time .total').text(timeFormate(statusObj['dur']));
                      $('.timing .played').css('width', statusObj['cur']/statusObj['dur'] * $('.timing').width());

                        $('.timing .download').css('width', statusObj['downloading'] * $('.timing').width());
                      if (statusObj['playing']){
                          $('.controls img:eq(1)').removeClass('pause').addClass('play');
                          $('.controls img:eq(1)')[0].src = 'images/player_play.png'; 
                      }else{
                          $('.controls img:eq(1)').removeClass('play').addClass('pause');
                          $('.controls img:eq(1)')[0].src = 'images/player_pause.png';
                         
                      }
                      if (statusObj['downloading'] >= 1 && (statusObj['cur'] >= statusObj['dur'] - 1000 || !statusObj['playing'])){
                          clearInterval(updater);
                          playNextTrack(index, vol);
                          console.log('playNextTrack');
                      }
                  }
                }, 1000);
            }
            /*
            暂停播放
             */
            var pauseTrack = function(){
                LuooFm.pause();
                clearInterval(updater);
            }
            

            $('.luoo-fm-player-body .controls .play').live('click', function(e){
                var target = $(e.currentTarget);
                if (LuooFm) {
                    LuooFm.pause();
                    console.log('now will be pause');
                    control = "pause";
                   target.removeClass('play').addClass('pause');
                   target[0].src = 'images/player_pause.png';
                }
            });
            $('.luoo-fm-player-body .controls .pause').live('click', function(e){
              var target = $(e.currentTarget);
                if (LuooFm) {
                  LuooFm.play();
                  control = "play";
                  console.log("now will be paly");
                  target.removeClass('pause').addClass('play');
                  target[0].src = 'images/player_play.png'; 
                } 
            });
            $('.luoo-fm-player-body .controls .pre').on('click', function(e){
                  var index = $('.list-wrap ul li.selected').attr('index');
                  var vol = $('.list-wrap ul li.selected').parent().attr('vol');
                  console.log('index  ' + index + ' vol  ' + vol);
                  playPreTrack(index, vol);
            });

            $('.luoo-fm-player-body .controls .next').on('click', function(e){
                  var index = $('.list-wrap ul li.selected').attr('index');
                  var vol = $('.list-wrap ul li.selected').parent().attr('vol');
                  playNextTrack(index, vol);
            });
            
            $('.luoo-fm-player-body .controls img').on('mousedown touchstart', function(e){
                $(e.currentTarget).addClass('pressed');
                $('.luoo-fm-player-body .controls img').one('mouseup touchend', function(e){
                    $(e.currentTarget).removeClass('pressed');
                });   
            });

            /*
            播放界面，列表界面切换
             */
            $('.logo').on('click', function(){
                if ($('#luoo_list').css('left') == '0px'){
                    $('#luoo_player').show();
                    $('#luoo_list').show();
                    $('#luoo_player').css('left', '0');
                    $('#luoo_list').css('left', '100%');
                    
                }else{
                    $('#luoo_player').show();
                    $('#luoo_list').show();
                    $('#luoo_player').css('left', '-100%');
                    $('#luoo_list').css('left', '0');
                    
                }                
            });

            //播放列表曲目点击。播放之
            $('.list-wrap ul li').live('click', function(e){
                $('.list-wrap ul li.selected').removeClass('selected');
                var target = $(e.currentTarget);
                target.addClass('selected');                 
                  console.log("play~~");
                  $('.track-info .title').text(target.text());
                  $('.track-info .album').text(target.attr('artist'));
                  $('.poster img')[0].src = target.attr('poster'); 
                  playTrack(target.attr('index'), target.parent().attr('vol'));
            });     

            /*
            单期点击收放动作
             */
            $('.list-wrap ul h3').live('click', function(e){
                var target = $(e.currentTarget).parent();
                target.find('h3 span').css('overflow', 'hidden');
                target.find('h3 span').css('display', 'block');
                target.toggleClass('open');
                if (target.hasClass('open')){
                  target.animate({
                    height:target.height() + $(target.find('li')[0]).height() * target.find('li').length
                  },400);
                  target.find('h3 span').animate({
                    textIndent:target.width() - 80 -target.find('h3 span').width()
                  }, 400);
                }else{
                  target.animate({
                    height:target.height() - $(target.find('li')[0]).height() * target.find('li').length
                  },400);
                   target.find('h3 span').animate({
                    textIndent:0
                  }, 400);
                }                
            });

            /*
            phonegap加载完毕之后，通过插件获取播放列表，插件代码配置在myplaylist.js
             */
            document.addEventListener("deviceready", onDeviceReady, false);
            function onDeviceReady() { 
                // get the latest playlist form start to end
                var getPlayList = function(start, end){
                    window.plugins.luoogetplaylist.getPlayList(start, function(result){
                        if (result.substr(-1) != '}'){
                          getPlayList(start, end);
                          return;
                        }
                        renderVol(JSON.parse(result));
                        setTimeout(function(){
                            // if player never played befor, play the first song.
                            if ($('.list-wrap ul li.selected').length == 0){
                                control = "play";
                                $('.list-wrap ul:first li:first').click();
                            }                            
                         }, 0);
                        if (start < end){
                            getPlayList(start + 1, end);
                        }
                    },
                    function(e){
                        console.log(e);
                        //get play list again, if something wrong was happend
                        getPlayList(start, end); 
                        return;
                    });  
                }
                getPlayList(0, 4); 
            }            
        });  
    </script></head>
<body>
  <div class="luoo-fm">
    <ul class="page" id="luoo_player">
      <div class="luoo-fm-player-body">
        <div class="logo"></div>
        <div class="poster">
          <img src="http://www.luoo.net/wp-content/uploads/337.jpg" alt=""></div>
        <div class="track-info">
          <p class="title">The Vera Violets</p>
          <p class="album">Somewhere Else 选自《Somewhere Else》</p>
        </div>
        <div class="controls">
          <img src="images/player_rew.png" class="pre">
          <img src="images/player_play.png" class="play">
          <img src="images/player_fwd.png" class="next"></div>
        <div class="timing">
          <div class="download"></div>
          <div class="played"></div>
          <div class="time">
            <span class="now">0:00</span>
            <span class="total">0:00</span>
          </div>
        </div>
      </div>
    </ul>
    <ul class="page" id="luoo_list">
      <div class="logo"></div>
      <div class="list-wrap"></div>
    </ul>
  </div>
</body>
</html>